<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Контакты</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:2rem; line-height:1.5; }
    form { max-width:560px; display:grid; gap:.75rem; }
    input,textarea,button { font:inherit; padding:.6rem .7rem; }
    textarea { min-height:140px; }
    .muted{color:#666;font-size:14px}
    .ok{color:green} .err{color:#c00}
    code{background:#f4f4f4;padding:.1rem .3rem;border-radius:.25rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  </style>
  <!-- explicit render -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=tsReady&render=explicit" async defer></script>
</head>
<body>
  <h1>Контакты</h1>

  <p class="muted row">
    Host: <code id="host"></code>
    <span>·</span>
    Site key: <code id="sk-head"></code>
    <button id="retryBtn" type="button">Обновить проверку</button>
  </p>

  <form id="contactForm" action="/contact" method="POST">
    <input name="name" placeholder="Ваше имя" required>
    <input name="email" type="email" placeholder="Ваш e-mail" required>
    <textarea name="message" placeholder="Сообщение" required></textarea>

    <!-- токен -->
    <input type="hidden" name="cf-turnstile-response" id="ts-response">

    <!-- контейнер виджета -->
    <div id="ts-container"></div>

    <button type="submit" id="submitBtn" disabled>Отправить</button>
  </form>

  <p id="ts-status" class="muted"></p>
  <p id="status"></p>

  <script>
    // ВСТАВЬ СВОЙ РЕАЛЬНЫЙ SITE KEY:
    const SITE_KEY = '0x4AAAAAABzukrBYa83MJypa';

    document.getElementById('host').textContent = location.hostname;
    document.getElementById('sk-head').textContent = SITE_KEY.slice(0,8) + '…';

    let widgetId = null;
    const tsContainer = document.getElementById('ts-container');
    const tsStatus = document.getElementById('ts-status');
    const submitBtn = document.getElementById('submitBtn');
    const retryBtn = document.getElementById('retryBtn');

    function setStatus(msg, cls){ tsStatus.textContent = msg; tsStatus.className = 'muted ' + (cls||''); }
    function enableSubmit(on){ submitBtn.disabled = !on; }

    function renderWidget(){
      // гарантированно 1 экземпляр
      if (widgetId !== null && window.turnstile) { try { turnstile.remove(widgetId); } catch(e){} widgetId = null; }
      tsContainer.innerHTML = '';
      try{
        widgetId = turnstile.render('#ts-container', {
          sitekey: SITE_KEY,
          retry: 'never',                 // ← отключаем автоповторы (важно)
          'refresh-expired': 'auto',      // токен сам обновится по истечении
          callback: tsOnSuccess,
          'expired-callback': tsOnExpired,
          'error-callback': tsOnError
        });
        setStatus('Turnstile загружен — подтвердите проверку');
        enableSubmit(false);
      }catch(e){
        setStatus('Ошибка инициализации Turnstile: '+e, 'err');
      }
    }

    function tsOnSuccess(token){
      const t = token || '';
      document.getElementById('ts-response').value = t;
      setStatus('Turnstile OK: токен получен ('+t.length+' симв.)', 'ok');
      enableSubmit(!!t);
    }
    function tsOnExpired(){
      document.getElementById('ts-response').value = '';
      setStatus('Turnstile истёк — обновите проверку');
      enableSubmit(false);
    }
    function tsOnError(err){
      document.getElementById('ts-response').value = '';
      setStatus('Turnstile error: '+(err||'unknown')+' — нажмите «Обновить проверку»', 'err');
      enableSubmit(false);
    }

    function tsReady(){ renderWidget(); }
    window.tsReady = tsReady;

    retryBtn.addEventListener('click', renderWidget);

    // отправка как x-www-form-urlencoded
    const form = document.getElementById('contactForm');
    const statusEl = document.getElementById('status');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusEl.textContent = 'Отправляю…'; statusEl.className = '';
      const tok = document.getElementById('ts-response').value;
      if(!tok){ statusEl.textContent = 'Подтвердите проверку «Я не робот»'; statusEl.className='err'; return; }

      const fd = new FormData(form);
      const params = new URLSearchParams(); for (const [k,v] of fd.entries()) params.append(k, v.toString());

      try{
        const resp = await fetch(form.action, {

