<!doctype html>
<html lang="ru">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Контакты</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; line-height: 1.5; }
    form { max-width: 560px; display:grid; gap:.75rem; }
    input, textarea, button { font: inherit; padding:.6rem .7rem; }
    textarea { min-height: 140px; }
    .muted { color:#666; font-size:14px; }
    .ok { color: green; }
    .err { color: #c00; }
    code{background:#f4f4f4;padding:.1rem .3rem;border-radius:.25rem}
  </style>
  <!-- Turnstile explicit -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=tsReady&render=explicit" async defer></script>
</head>
<body>
  <h1>Контакты</h1>

  <p class="muted">
    Host: <code id="host"></code> · Site key: <code id="sk-head"></code>
  </p>

  <form id="contactForm" action="/contact" method="POST">
    <input name="name" placeholder="Ваше имя" required>
    <input name="email" type="email" placeholder="Ваш e-mail" required>
    <textarea name="message" placeholder="Сообщение" required></textarea>

    <!-- скрытое поле под токен -->
    <input type="hidden" name="cf-turnstile-response" id="ts-response">

    <!-- контейнер для виджета -->
    <div id="ts-container"></div>

    <button type="submit" id="submitBtn" disabled>Отправить</button>
  </form>

  <p id="ts-status" class="muted"></p>
  <p id="status"></p>

  <script>
    // ==== ВСТАВЬ СВОЙ РЕАЛЬНЫЙ SITE KEY НИЖЕ ====
    const SITE_KEY = '0x4AAAAAABzuSh1PhYJkUsxg';

    // Покажем текущий host и "голову" ключа — чтобы проверить, что правим нужный виджет
    document.getElementById('host').textContent = location.hostname;
    document.getElementById('sk-head').textContent = SITE_KEY.slice(0,8) + '…';

    let widgetId = null;

    function tsOnSuccess(token) {
      const t = token || '';
      document.getElementById('ts-response').value = t;
      document.getElementById('ts-status').textContent =
        'Turnstile OK: токен получен (' + t.length + ' символов, ' + t.slice(0,12) + '…)';
      document.getElementById('submitBtn').disabled = !t;
    }
    function tsOnExpired() {
      document.getElementById('ts-response').value = '';
      document.getElementById('ts-status').textContent = 'Turnstile истёк — подтвердите заново';
      document.getElementById('submitBtn').disabled = true;
      if (window.turnstile && widgetId !== null) turnstile.reset(widgetId);
    }
    function tsOnError() {
      document.getElementById('ts-response').value = '';
      document.getElementById('ts-status').textContent = 'Turnstile ошибка — проверьте домены/блокировщики';
      document.getElementById('submitBtn').disabled = true;
    }

    function tsReady() {
      try {
        widgetId = turnstile.render('#ts-container', {
          sitekey: SITE_KEY,
          callback: tsOnSuccess,
          'expired-callback': tsOnExpired,
          'error-callback': tsOnError
        });
        document.getElementById('ts-status').textContent = 'Turnstile загружен, подтвердите проверку';
      } catch(e) {
        document.getElementById('ts-status').textContent = 'Ошибка инициализации Turnstile: ' + e;
      }
    }
    window.tsReady = tsReady;

    // Отправляем как x-www-form-urlencoded
    const form = document.getElementById('contactForm');
    const statusEl = document.getElementById('status');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Отправляю…'; statusEl.className = '';

      const tok = document.getElementById('ts-response').value;
      if (!tok) { statusEl.textContent = 'Подтвердите проверку «Я не робот»'; statusEl.className='err'; return; }

      const fd = new FormData(form);
      const params = new URLSearchParams();
      for (const [k, v] of fd.entries()) params.append(k, v.toString());

      try {
        const resp = await fetch(form.action, {
          method: 'POST',
          headers: { 'content-type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params
        });
        let data = null; try { data = await resp.json(); } catch {}
        if (resp.ok && data && data.ok) {
          statusEl.textContent = 'Сообщение отправлено.'; statusEl.className = 'ok';
          form.reset(); document.getElementById('submitBtn').disabled = true;
          if (window.turnstile && widgetId !== null) turnstile.reset(widgetId);
          document.getElementById('ts-status').textContent = '';
        } else {
          const msg = (function(){
            if (!data) return 'status=' + resp.status + ' (нет тела)';
            const pieces = [
              'status=' + resp.status,
              data.status != null ? ('mcStatus=' + data.status) : null,
              data.error ? ('error=' + data.error) : null,
              data.details ? ('details=' + data.details) : null,
              data.text ? ('text=' + String(data.text).slice(0,160).replace(/\s+/g,' ')) : null
            ].filter(Boolean);
            return pieces.join(' | ');
          })();
          statusEl.textContent = 'Ошибка: ' + msg;
          statusEl.className = 'err';
          if (window.turnstile && widgetId !== null) turnstile.reset(widgetId);
          document.getElementById('submitBtn').disabled = true;
        }
      } catch (err) {
        statusEl.textContent = 'Сетевая ошибка: ' + err; statusEl.className = 'err';
      }
    }, { capture: true });
  </script>
</body>
</html>
