<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Контакты</title>

<link rel="stylesheet" href="assets/bg.css">

<style>
:root{ --bg:#0b0f19; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:var(--text)}
a{color:var(--accent);text-decoration:none}
header{position:sticky;top:0;background:rgba(10,14,32,.75);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
.container{max-width:1100px;margin:0 auto;padding:0 16px}
.nav{display:flex;align-items:center;gap:12px;padding:12px 0;flex-wrap:wrap}
.badge{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.2);border-radius:999px;color:var(--text)}
.card{background:rgba(17,24,39,.82);border:1px solid rgba(255,255,255,.07);border-radius:18px;padding:22px;box-shadow:0 8px 30px rgba(0,0,0,.3);margin:18px 0}
h1{margin:0 0 12px 0;font-size:28px}
p.muted{color:var(--muted);margin-top:4px}

/* Форма */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
@media (max-width: 820px){ .form-grid{grid-template-columns:1fr} }
label{font-size:13px;color:var(--muted);display:block;margin:0 0 6px}
input, select, textarea{
  width:100%; background:rgba(255,255,255,.04); color:var(--text);
  border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:10px 12px;
}
textarea{min-height:140px; resize:vertical}
.small{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
button.btn, .btn{
  display:inline-block;padding:10px 14px;border:1px solid rgba(255,255,255,.25);
  border-radius:12px;color:var(--text);background:transparent;cursor:pointer
}
.btn:hover{border-color:rgba(255,255,255,.4)}

/* honeypot (антиспам) */
.hp{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

/* uploader */
.file-uploader{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
#filesInfo{min-height:1em}

/* Нижняя «подушка» под sticky-footer */
main{ padding-bottom: 120px; }

/* Стрип с адресами и контактами */
.contact-strip{
  margin: 12px 0 24px;
  background: rgba(17,24,39,.82);
  border:1px solid rgba(255,255,255,.07);
  border-radius:16px;
  padding:14px 16px;
}
.contact-strip .grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:16px;
  align-items:flex-start;
}
@media (max-width: 720px){
  .contact-strip .grid{grid-template-columns:1fr}
}
.contact-strip h3{margin:0 0 6px 0; font-size:16px}
.contact-strip address{font-style:normal; color:var(--muted); line-height:1.6; margin:0}
.contact-strip a{white-space:nowrap}
.contact-strip .right p{margin:0 0 6px 0; display:flex; align-items:center; gap:8px}

/* Иконки (встроенные SVG) */
.icon{
  width:14px; height:14px; display:inline-block; flex:0 0 14px;
  opacity:.9; color:var(--text);
}
.icon svg{ width:100%; height:100%; display:block; }

/* Разделитель между адресными блоками */
.contact-strip .divider{
  grid-column:1 / -1;
  height:1px;
  background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.18), rgba(255,255,255,0));
  margin: 2px 0 4px;
}

/* Футер */
.site-footer{
  position: fixed; left:0; right:0; bottom:0; text-align:center;
  padding:12px 16px; color:#9ca3af; background: rgba(10,14,32,.55);
  border-top:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px); z-index:100;
}
</style>

<!-- Turnstile explicit -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=tsReady&render=explicit" async defer></script>
</head>

<script defer src="assets/i18n.js"></script>

<body class="contacts">
<header>
  <div class="container nav">
    <a href="index.html" class="badge" id="backHome">← На главную</a>
    <span style="margin-left:4px" id="pageTitle">Контакты</span>
  </div>
</header>

<main class="container">
  <!-- Карточка с формой -->
  <section class="card">
    <h1 id="h1">Связаться с нами</h1>
    <p class="muted" id="lead">Опишите задачу — мы предложим варианты решения и свяжемся с вами.</p>

    <!-- enctype добавлен для файлов -->
    <form id="briefForm" action="/contact" method="post" enctype="multipart/form-data" novalidate>
      <div class="form-grid">
        <div>
          <label for="name" id="lblName">Ваше имя *</label>
          <input id="name" name="name" required placeholder="Иван Иванов">
        </div>
        <div>
          <label for="email" id="lblEmail">Email *</label>
          <input id="email" name="email" type="email" required placeholder="you@company.com">
        </div>
        <div>
          <label for="phone" id="lblPhone">Телефон / WhatsApp</label>
          <input id="phone" name="phone" placeholder="+420 607 828 092">
        </div>
        <div>
          <label for="company" id="lblCompany">Компания</label>
          <input id="company" name="company" placeholder="ООО «Компания»">
        </div>
        <div>
          <label for="service" id="lblService">Направление *</label>
          <select id="service" name="service" required>
            <option value="" selected disabled id="optChoose">Выберите…</option>
            <option id="optEnergy">Энергетический инжиниринг</option>
            <option id="optFSA">ФСА / ТРИЗ</option>
            <option id="optLab">Лабораторные исследования</option>
          </select>
        </div>
        <div>
          <label for="deadline" id="lblDeadline">Срок / дедлайн</label>
          <input id="deadline" name="deadline" placeholder="Напр., до 30.09 или 4–6 недель">
        </div>
        <div style="grid-column:1/-1">
          <label for="message" id="lblMessage">Краткое описание задачи *</label>
          <textarea id="message" name="message" required placeholder="1–2 абзаца: текущая ситуация, ограничения, желаемый результат"></textarea>
        </div>

        <!-- honeypot -->
        <input class="hp" type="text" id="website" name="website" tabindex="-1" autocomplete="off" placeholder="Оставьте пустым">
      </div>

      <!-- Вложения -->
      <div style="grid-column:1/-1">
        <label id="lblFiles" data-i18n="labels.attach">Вложения (PDF/JPG, до 5 МБ, до 3 файлов)</label>
        <div class="file-uploader">
          <input id="files" name="files" type="file" accept=".pdf,.jpg,.jpeg" multiple hidden>
          <button type="button" class="btn" id="btnPickFiles" data-i18n="ui.attach_btn">Вложить файлы</button>
          <span class="small" id="filesInfo" data-i18n="ui.files_none">Файлы не выбраны</span>
        </div>
        <p class="small" id="hintFiles" data-i18n="hint_attach">Допустимые: PDF, JPG. Максимум 3 файла, каждый до 5 МБ. И до 15 МБ суммарно.</p>
      </div>

      <!-- Turnstile -->
      <input type="hidden" name="cf-turnstile-response" id="ts-response">
      <div class="actions">
        <div id="ts-container"></div>
        <button type="submit" class="btn" id="submitBtn" disabled>Отправить</button>
        <a class="btn" id="btnPubs" href="publications.html">Публикации</a>
      </div>

      <!-- Fallback -->
      <div id="fallback" class="card" style="margin-top:16px;display:none">
        <p class="small" id="fbNote">
          Если автоматическая отправка не прошла, скопируйте текст ниже и отправьте вручную на
          <a href="mailto:office@neweee.com">office@neweee.com</a>.
        </p>
        <textarea id="fallbackText"></textarea>
        <div class="actions">
          <button type="button" class="btn" id="copyBtn">Скопировать</button>
        </div>
      </div>
    </form>
  </section>

  <!-- НИЖНИЙ СТРИП (2 адреса, у каждого справа телефон и e-mail) -->
  <section class="contact-strip">
    <div class="grid">

      <!-- Регистрационный адрес -->
      <div>
        <h3 id="regAddrTitle">Адрес регистрации:</h3>
        <address id="regAddrText">
          NEW ENERGY AND ENGINEERING LTD<br>
          Office No. 416, Burlington Tower, Business Bay, Dubai<br>
          P.O. Box 487644, United Arab Emirates<br>
          ICC20211393
        </address>
      </div>
      <div class="right">
        <p>
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2A19.7 19.7 0 0 1 3.1 5.18 2 2 0 0 1 5.06 3h3a2 2 0 0 1 2 1.72c.1.74.27 1.46.5 2.15a2 2 0 0 1-.45 2.11L9 10a16 16 0 0 0 5 5l1-1.11a2 2 0 0 1 2.11-.45c.69.23 1.41.4 2.15.5A2 2 0 0 1 22 16.92z"/>
            </svg>
          </span>
          <a href="tel:+420607828092">+420 607 828 092</a>
        </p>
        <p>
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>
              <path d="m22 6-10 7L2 6"/>
            </svg>
          </span>
          <a href="mailto:office@neweee.com">office@neweee.com</a>
        </p>
      </div>

      <!-- Разделитель -->
      <div class="divider" aria-hidden="true"></div>

      <!-- Почтовый адрес -->
      <div>
        <h3 id="mailAddrTitle">Почтовый адрес:</h3>
        <address id="mailAddrText">
          Kovarova 2240/2<br>
          591 01, Zdar nad Sazavou<br>
          Czech Republic<br>
          <br>
        </address>
      </div>
      <div class="right">
        <p>
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2A19.7 19.7 0 0 1 3.1 5.18 2 2 0 0 1 5.06 3h3a2 2 0 0 1 2 1.72c.1.74.27 1.46.5 2.15a2 2 0 0 1-.45 2.11L9 10a16 16 0 0 0 5 5l1-1.11a2 2 0 0 1 2.11-.45c.69.23 1.41.4 2.15.5A2 2 0 0 1 22 16.92z"/>
            </svg>
          </span>
          <a href="tel:+420607828092">+420 607 828 092</a>
        </p>
        <p>
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>
              <path d="m22 6-10 7L2 6"/>
            </svg>
          </span>
          <a href="mailto:office@neweee.com">office@neweee.com</a>
        </p>
      </div>

    </div>
  </section>
</main>

<footer class="site-footer">© 2025 NEW ENERGY &amp; ENGINEERING LTD</footer>

<script>
// ===== Turnstile (explicit) — ключи
const SITEKEY_PAGES = '0x4AAAAAABzuSh1PhYJkUsxg'; // allowlist: neweee-pages.pages.dev
const SITEKEY_PROD  = '0x4AAAAAABzukrBYa83MJypa';  // allowlist: neweee.com, www.neweee.com
function pickSiteKey() {
  const h = location.hostname;
  if (h.endsWith('neweee-pages.pages.dev')) return SITEKEY_PAGES;
  if (h === 'neweee.com' || h === 'www.neweee.com') return SITEKEY_PROD;
  return SITEKEY_PAGES;
}
const SITE_KEY = pickSiteKey();

let widgetId = null;
function enableSubmit(on){ document.getElementById('submitBtn').disabled = !on; }
function tsReady(){
  try{
    widgetId = turnstile.render('#ts-container', {
      sitekey: SITE_KEY,
      retry: 'never',
      callback: (token)=>{
        document.getElementById('ts-response').value = token || '';
        enableSubmit(!!token);
      },
      'expired-callback': ()=>{
        document.getElementById('ts-response').value = '';
        enableSubmit(false);
      },
      'error-callback': ()=>{
        document.getElementById('ts-response').value = '';
        enableSubmit(false);
      }
    });
  }catch(e){ enableSubmit(false); }
}
window.tsReady = tsReady;

// ===== i18n helpers & dict =====
function normalizeLang(v) {
  v = (v || '').toString().toLowerCase();
  if (v === 'ua' || v.startsWith('uk')) return 'uk';
  if (v.startsWith('en')) return 'en';
  return 'ru';
}
function getLang() {
  let v = new URLSearchParams(location.search).get('lang');
  if (!v && window.__lang) v = String(window.__lang);
  if (!v && localStorage.getItem('lang')) v = localStorage.getItem('lang');
  if (!v) v = document.documentElement.lang || navigator.language || 'ru';
  return normalizeLang(v);
}
if (typeof window.setLang !== 'function') {
  window.setLang = function (code) {
    const lang = normalizeLang(code);
    localStorage.setItem('lang', lang);
    document.documentElement.lang = lang;
    window.__lang = lang;
    window.dispatchEvent(new CustomEvent('langchange', { detail: { lang } }));
  };
}

const I18N = {
  ru:{
    nav: { back: '← На главную', title: 'Контакты' },
    head: { h1: 'Связаться с нами', lead: 'Опишите задачу — мы предложим варианты решения и свяжемся с вами.' },
    labels: {
      name: 'Ваше имя *', email: 'Email *', phone: 'Телефон / WhatsApp', company: 'Компания',
      service: 'Направление *', deadline: 'Срок / дедлайн', message: 'Краткое описание задачи *',
      choose: 'Выберите…', energy: 'Энергетический инжиниринг', fsa: 'ФСА / ТРИЗ', lab: 'Лабораторные исследования',
      attach: 'Вложения (PDF/JPG, до 5 МБ, до 3 файлов)'
    },
    ph: {
      name: 'Иван Иванов',
      email: 'you@company.com',
      phone: '+420 607 828 092',
      company: 'ООО «Компания»',
      deadline: 'Напр., до 30.09 или 4–6 недель',
      message: '1–2 абзаца: текущая ситуация, ограничения, желаемый результат'
    },
    ui: {
      send: 'Отправить', sending: 'Отправка…', pubs: 'Публикации', copy: 'Скопировать', copied: 'Скопировано ✓',
      attach_btn: 'Вложить файлы', files_none: 'Файлы не выбраны', files_selected: 'Выбрано файлов: {n}'
    },
    msg: {
      required: 'Пожалуйста, заполните обязательные поля.',
      captcha: 'Подтвердите проверку «Я не робот».',
      fail: 'Не удалось отправить форму. Попробуйте ещё раз через минуту.',
      fallbackAlert: 'Не удалось отправить автоматически. Можно скопировать текст и отправить вручную.'
    },
    success: { title: 'Спасибо!', text: 'Мы получили вашу заявку и свяжемся с вами в ближайшее время.' },

    addr: {
      reg_title: 'Адрес регистрации:',
      reg_text:
        'NEW ENERGY AND ENGINEERING LTD<br>Office No. 416, Burlington Tower, Business Bay, Dubai<br>P.O. Box 487644, United Arab Emirates<br>ICC20211393',
      mail_title: 'Почтовый адрес:',
      mail_text:
        'Kovarova 2240/2<br>591 01, Zdar nad Sazavou<br>Czech Republic'
    },

    hint_attach: 'Допустимые: PDF, JPG. Максимум 3 файла, каждый до 5 МБ. И до 15 МБ суммарно.',
    fallbackNote: 'Если автоматическая отправка не прошла, скопируйте текст ниже и отправьте вручную на'
  },
  en:{
    nav: { back: '← Home', title: 'Contacts' },
    head: { h1: 'Get in touch', lead: 'Describe your task — we’ll propose solutions and get back to you.' },
    labels: {
      name: 'Your name *', email: 'Email *', phone: 'Phone / WhatsApp', company: 'Company',
      service: 'Service *', deadline: 'Deadline', message: 'Short brief *',
      choose: 'Choose…', energy: 'Energy engineering', fsa: 'FCA / TRIZ', lab: 'Laboratory research',
      attach: 'Attachments (PDF/JPG, up to 5 MB, max 3 files)'
    },
    ph: {
      name: 'John Smith',
      email: 'you@company.com',
      phone: '+420 607 828 092',
      company: 'Company LLC',
      deadline: 'e.g., by 30 Sep or 4–6 weeks',
      message: '1–2 paragraphs: current situation, constraints, desired outcome'
    },
    ui: {
      send: 'Send', sending: 'Sending…', pubs: 'Publications', copy: 'Copy', copied: 'Copied ✓',
      attach_btn: 'Attach files', files_none: 'No files selected', files_selected: 'Files selected: {n}'
    },
    msg: {
      required: 'Please fill in the required fields.',
      captcha: 'Please complete the “I’m not a robot” check.',
      fail: 'We couldn’t send the form. Please try again in a minute.',
      fallbackAlert: 'Automatic sending failed. You can copy the text and send it manually.'
    },
    success: { title: 'Thank you!', text: 'We’ve received your request and will get back to you shortly.' },

    addr: {
      reg_title: 'Registered address:',
      reg_text:
        'NEW ENERGY AND ENGINEERING LTD<br>Office No. 416, Burlington Tower, Business Bay, Dubai<br>P.O. Box 487644, United Arab Emirates<br>ICC20211393',
      mail_title: 'Mailing address:',
      mail_text:
        'Kovarova 2240/2<br>591 01, Zdar nad Sazavou<br>Czech Republic'
    },

    hint_attach: 'Allowed: PDF, JPG. Max 3 files, 5 MB each. Up to 15 MB total.',
    fallbackNote: 'If automatic sending failed, copy the text below and email it to'
  },
  uk:{
    nav: { back: '← На головну', title: 'Контакти' },
    head: { h1: 'Зв’яжіться з нами', lead: 'Опишіть задачу — ми запропонуємо рішення і невдовзі відповімо.' },
    labels: {
      name: 'Ваше ім’я *', email: 'Email *', phone: 'Телефон / WhatsApp', company: 'Компанія',
      service: 'Напрям *', deadline: 'Строк / дедлайн', message: 'Короткий опис задачі *',
      choose: 'Оберіть…', energy: 'Енергетичний інжиніринг', fsa: 'ФСА / TRIZ', lab: 'Лабораторні дослідження',
      attach: 'Вкладення (PDF/JPG, до 5 МБ, максимум 3 файли)'
    },
    ph: {
      name: 'Іван Іванов',
      email: 'you@company.com',
      phone: '+420 607 828 092',
      company: 'ТОВ «Компанія»',
      deadline: 'наприклад, до 30.09 або 4–6 тижнів',
      message: '1–2 абзаци: поточна ситуація, обмеження, бажаний результат'
    },
    ui: {
      send: 'Надіслати', sending: 'Надсилання…', pubs: 'Публікації', copy: 'Скопіювати', copied: 'Скопійовано ✓',
      attach_btn: 'Додати файли', files_none: 'Файли не вибрані', files_selected: 'Вибрано файлів: {n}'
    },
    msg: {
      required: 'Будь ласка, заповніть обов’язкові поля.',
      captcha: 'Підтвердіть перевірку «Я не робот».',
      fail: 'Не вдалося надіслати форму. Спробуйте ще раз за хвилину.',
      fallbackAlert: 'Автоматичне надсилання не спрацювало. Ви можете скопіювати текст і надіслати вручну.'
    },
    success: { title: 'Дякуємо!', text: 'Ми отримали вашу заявку і невдовзі з вами зв’яжемося.' },

    addr: {
      reg_title: 'Адреса реєстрації:',
      reg_text:
        'NEW ENERGY AND ENGINEERING LTD<br>Office No. 416, Burlington Tower, Business Bay, Dubai<br>P.O. Box 487644, Об’єднані Арабські Емірати<br>ICC20211393',
      mail_title: 'Поштова адреса:',
      mail_text:
        'Kovarova 2240/2<br>591 01, Zdar nad Sazavou<br>Czech Republic'
    },

    hint_attach: 'Дозволено: PDF, JPG. Максимум 3 файли, по 5 МБ. І до 15 МБ сумарно.',
    fallbackNote: 'Якщо автоматичне надсилання не спрацювало, скопіюйте текст нижче й надішліть на'
  }
};

function t(path) {
  const lang = getLang();
  const segs = path.split('.');
  let obj = I18N[lang] || I18N.ru;
  for (const s of segs) { obj = obj?.[s]; if (!obj) break; }
  return (typeof obj === 'string') ? obj : '';
}

function applyLangUI() {
  const lang = getLang();
  document.documentElement.lang = lang;

  const $id = (id)=>document.getElementById(id);
  if ($id('backHome')) $id('backHome').textContent = t('nav.back');
  if ($id('pageTitle')) $id('pageTitle').textContent = t('nav.title');
  if ($id('h1')) $id('h1').textContent = t('head.h1');
  if ($id('lead')) $id('lead').textContent = t('head.lead');

  if ($id('lblName')) $id('lblName').textContent = t('labels.name');
  if ($id('lblEmail')) $id('lblEmail').textContent = t('labels.email');
  if ($id('lblPhone')) $id('lblPhone').textContent = t('labels.phone');
  if ($id('lblCompany')) $id('lblCompany').textContent = t('labels.company');
  if ($id('lblService')) $id('lblService').textContent = t('labels.service');
  if ($id('lblDeadline')) $id('lblDeadline').textContent = t('labels.deadline');
  if ($id('lblMessage')) $id('lblMessage').textContent = t('labels.message');
  if ($id('lblFiles')) $id('lblFiles').textContent = t('labels.attach');
  if ($id('hintFiles')) $id('hintFiles').textContent = t('hint_attach');
  if ($id('btnPickFiles')) $id('btnPickFiles').textContent = t('ui.attach_btn');
  if ($id('filesInfo')) $id('filesInfo').textContent = t('ui.files_none');

  if ($id('optChoose')) $id('optChoose').textContent = t('labels.choose');
  if ($id('optEnergy')) $id('optEnergy').textContent = t('labels.energy');
  if ($id('optFSA')) $id('optFSA').textContent = t('labels.fsa');
  if ($id('optLab')) $id('optLab').textContent = t('labels.lab');

  const setPh = (id, key) => { const el = $id(id); if (el) el.placeholder = t('ph.'+key); };
  setPh('name', 'name'); setPh('email', 'email'); setPh('phone', 'phone');
  setPh('company', 'company'); setPh('deadline', 'deadline'); setPh('message', 'message');

  const submitBtn = $id('submitBtn'); if (submitBtn) submitBtn.textContent = t('ui.send');
  const btnPubs = $id('btnPubs'); if (btnPubs) btnPubs.textContent = t('ui.pubs');
  const copyBtn = $id('copyBtn'); if (copyBtn) copyBtn.textContent = t('ui.copy');

  if ($id('regAddrTitle')) $id('regAddrTitle').textContent = t('addr.reg_title');
  if ($id('mailAddrTitle')) $id('mailAddrTitle').textContent = t('addr.mail_title');
  if ($id('regAddrText')) $id('regAddrText').innerHTML = t('addr.reg_text');
  if ($id('mailAddrText')) $id('mailAddrText').innerHTML = t('addr.mail_text');

  const fb = $id('fallback'), note = $id('fbNote');
  if (fb && note) {
    const mail = (note.querySelector('a')?.outerHTML) || 'office@neweee.com';
    note.innerHTML = `${t('fallbackNote')} ${mail}.`;
  }
}

window.addEventListener('langchange', applyLangUI);
document.addEventListener('DOMContentLoaded', applyLangUI);

// Выбор файлов
document.addEventListener('DOMContentLoaded', ()=>{
  const input = document.getElementById('files');
  const pickBtn = document.getElementById('btnPickFiles');
  const info = document.getElementById('filesInfo');
  if (pickBtn && input) {
    pickBtn.addEventListener('click', ()=> input.click());
    input.addEventListener('change', ()=>{
      const files = Array.from(input.files || []);
      if (!files.length) { info.textContent = t('ui.files_none'); return; }
      info.textContent = (t('ui.files_selected') || 'Files selected: {n}').replace('{n}', files.length);
    });
  }
});

// ===== Отправка формы: multipart/form-data на /contact =====
const f = document.getElementById('briefForm');
const fb = document.getElementById('fallback');
const fbText = document.getElementById('fallbackText');
const copyBtn = document.getElementById('copyBtn');

function val(id){ return (document.getElementById(id)?.value || "").trim(); }
function isSpam(){ return (document.getElementById('website')?.value || "").trim().length > 0; }

f.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(isSpam()) return;

  const required = ['name','email','service','message'];
  for(const id of required){
    if(!val(id)){ alert(t('msg.required')); return; }
  }

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true; submitBtn.textContent = t('ui.sending');

  try{
    const fd = new FormData(f);
    const tok = document.getElementById('ts-response').value || '';
    if(!tok){ alert(t('msg.captcha')); throw new Error('no token'); }
    fd.set('cf-turnstile-response', tok);

    // validate files on client
    const fileInput = document.getElementById('files');
    const files = fileInput ? Array.from(fileInput.files) : [];
    if (files.length > 3) { alert('Слишком много файлов (макс. 3).'); throw new Error('too_many_files'); }
    let total = 0;
    for (const f of files) {
      const okType = ['application/pdf','image/jpeg'].includes(f.type) || /\.(pdf|jpe?g)$/i.test(f.name||'');
      if (!okType) { alert('Допустимы только PDF или JPG.'); throw new Error('bad_type'); }
      if (f.size > 5*1024*1024) { alert('Один из файлов больше 5 МБ.'); throw new Error('too_big'); }
      total += f.size;
      if (total > 15*1024*1024) { alert('Суммарный размер вложений больше 15 МБ.'); throw new Error('too_big_total'); }
    }

    const res = await fetch(f.action, { method: 'POST', body: fd });
    const json = await res.json().catch(()=> ({}));

    if(res.ok && json && json.ok){
      const title = t('success.title'), text = t('success.text');
      f.innerHTML = `<h2>${title}</h2><p class="muted">${text}</p>`;
      f.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }else{
      throw new Error(json && (json.error || json.text) || ('status '+res.status));
    }
  }catch(err){
    const lines = [
      `${t('labels.name').replace(' *','')}: ${val('name')}`,
      `${t('labels.email').replace(' *','')}: ${val('email')}`,
      val('phone') ? `${t('labels.phone')}: ${val('phone')}` : null,
      val('company') ? `${t('labels.company')}: ${val('company')}` : null,
      `${t('labels.service').replace(' *','')}: ${val('service')}`,
      val('deadline') ? `${t('labels.deadline')}: ${val('deadline')}` : null,
      '',
      (t('labels.message').replace(' *','') + ':'),
      val('message')
    ].filter(Boolean);
    fbText.value = lines.join('\r\n');
    fb.style.display = 'block';
    fb.scrollIntoView({ behavior: 'smooth', block: 'start' });
    alert(t('msg.fallbackAlert'));
  }finally{
    if(window.turnstile && widgetId!==null) turnstile.reset(widgetId);
    const submitBtn2 = document.getElementById('submitBtn');
    if (submitBtn2) { submitBtn2.disabled = false; submitBtn2.textContent = t('ui.send'); }
  }
});

copyBtn?.addEventListener('click', async () => {
  try{
    await navigator.clipboard.writeText(fbText.value);
    copyBtn.textContent = t('ui.copied');
    setTimeout(()=> copyBtn.textContent = t('ui.copy'), 1500);
  }catch(e){
    fbText.select(); document.execCommand('copy');
  }
});
</script>
</body>
</html>

