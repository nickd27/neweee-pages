<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Контакты</title>

<link rel="stylesheet" href="assets/bg.css">

<style>
:root{ --bg:#0b0f19; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:var(--text)}
a{color:var(--accent);text-decoration:none}
header{position:sticky;top:0;background:rgba(10,14,32,.75);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
.container{max-width:1100px;margin:0 auto;padding:0 16px}
.nav{display:flex;align-items:center;gap:12px;padding:12px 0;flex-wrap:wrap}
.badge{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.2);border-radius:999px;color:var(--text)}
.card{background:rgba(17,24,39,.82);border:1px solid rgba(255,255,255,.07);border-radius:18px;padding:22px;box-shadow:0 8px 30px rgba(0,0,0,.3);margin:18px 0}
h1{margin:0 0 12px 0;font-size:28px}
p.muted{color:var(--muted);margin-top:4px}

/* Форма */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
@media (max-width: 820px){ .form-grid{grid-template-columns:1fr} }
label{font-size:13px;color:var(--muted);display:block;margin:0 0 6px}
input, select, textarea{
  width:100%; background:rgba(255,255,255,.04); color:var(--text);
  border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:10px 12px;
}
textarea{min-height:140px; resize:vertical}
.small{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
button.btn, .btn{
  display:inline-block;padding:10px 14px;border:1px solid rgba(255,255,255,.25);
  border-radius:12px;color:var(--text);background:transparent;cursor:pointer
}
.btn:hover{border-color:rgba(255,255,255,.4)}

/* honeypot (антиспам) */
.hp{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

/* Нижняя «подушка» под sticky-footer */
main{ padding-bottom: 120px; }

/* Стрип с адресом и телефоном */
.contact-strip{
  margin: 12px 0 24px;
  background: rgba(17,24,39,.82);
  border:1px solid rgba(255,255,255,.07);
  border-radius:16px;
  padding:14px 16px;
}
.contact-strip .grid{
  display:grid; grid-template-columns:2fr 1fr; gap:16px; align-items:flex-start;
}
@media (max-width: 720px){ .contact-strip .grid{grid-template-columns:1fr} }
.contact-strip h3{margin:0 0 6px 0; font-size:16px}
.contact-strip address{font-style:normal; color:var(--muted); line-height:1.6; margin:0}
.contact-strip a{white-space:nowrap}

/* Футер */
.site-footer{
  position: fixed; left:0; right:0; bottom:0; text-align:center;
  padding:12px 16px; color:#9ca3af; background: rgba(10,14,32,.55);
  border-top:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px); z-index:100;
}
</style>

<!-- Turnstile explicit -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=tsReady&render=explicit" async defer></script>
</head>

<script defer src="assets/i18n.js"></script>

<body class="contacts">
<header>
  <div class="container nav">
    <a href="index.html" class="badge" id="backHome">← На главную</a>
    <span style="margin-left:4px" id="pageTitle">Контакты</span>
  </div>
</header>

<main class="container">
  <!-- Карточка с формой -->
  <section class="card">
    <h1 id="h1">Связаться с нами</h1>
    <p class="muted" id="lead">Опишите задачу — мы предложим варианты решения и свяжемся с вами.</p>

    <form id="briefForm" action="/contact" method="post" novalidate>
      <div class="form-grid">
        <div>
          <label for="name" id="lblName">Ваше имя *</label>
          <input id="name" name="name" required placeholder="Peter Novak">
        </div>
        <div>
          <label for="email" id="lblEmail">Email *</label>
          <input id="email" name="email" type="email" required placeholder="you@company.com">
        </div>
        <div>
          <label for="phone" id="lblPhone">Телефон / WhatsApp</label>
          <input id="phone" name="phone" placeholder="+420 607 828 092">
        </div>
        <div>
          <label for="company" id="lblCompany">Компания</label>
          <input id="company" name="company" placeholder="ООО «Компания»">
        </div>
        <div>
          <label for="service" id="lblService">Направление *</label>
          <select id="service" name="service" required>
            <option value="" selected disabled id="optChoose">Выберите…</option>
            <option id="optEnergy">Энергетический инжиниринг</option>
            <option id="optFSA">ФСА / ТРИЗ</option>
            <option id="optLab">Лабораторные исследования</option>
          </select>
        </div>
        <div>
          <label for="deadline" id="lblDeadline">Срок / дедлайн</label>
          <input id="deadline" name="deadline" placeholder="Напр., до 30.09 или 4–6 недель">
        </div>
        <div style="grid-column:1/-1">
          <label for="message" id="lblMessage">Краткое описание задачи *</label>
          <textarea id="message" name="message" required placeholder="1–2 абзаца: текущая ситуация, ограничения, желаемый результат"></textarea>
        </div>

        <!-- honeypot -->
        <input class="hp" type="text" id="website" name="website" tabindex="-1" autocomplete="off" placeholder="Оставьте пустым">
      </div>

      <!-- Turnstile -->
      <input type="hidden" name="cf-turnstile-response" id="ts-response">
      <div class="actions">
        <div id="ts-container"></div>
        <button type="submit" class="btn" id="submitBtn" disabled>Отправить</button>
        <a class="btn" id="btnPubs" href="publications.html">Публикации</a>
      </div>

      <!-- Fallback -->
      <div id="fallback" class="card" style="margin-top:16px;display:none">
        <p class="small" id="fbNote">
          Если автоматическая отправка не прошла, скопируйте текст ниже и отправьте вручную на
          <a href="mailto:office@neweee.com">office@neweee.com</a>.
        </p>
        <textarea id="fallbackText"></textarea>
        <div class="actions">
          <button type="button" class="btn" id="copyBtn">Скопировать</button>
        </div>
      </div>
    </form>
  </section>

  <!-- НИЖНИЙ СТРИП -->
  <section class="contact-strip">
    <div class="grid">
      <div>
        <h3 id="addrTitle">Адрес:</h3>
        <address id="addrText">
          NEW ENERGY AND ENGINEERING LTD<br>
          Office No. 416, Burlington Tower, Business Bay Dubai<br>
          P.O. Box 487644, United Arab Emirates<br>
          ICC20211393
        </address>
      </div>
      <div>
        <h3 id="phoneTitle">Телефон: ( WhatsApp, Viber )</h3>
        <p style="margin:0"><a href="tel:+420607828092">+420 607 828 092</a></p>
        <p><a href="mailto:office@neweee.com">office@neweee.com</a></p>
      </div>
    </div>
  </section>
</main>

<footer class="site-footer">© 2025 NEW ENERGY &amp; ENGINEERING LTD</footer>

<script>
// ===== Turnstile (explicit) — ключи
const SITEKEY_PAGES = '0x4AAAAAABzuSh1PhYJkUsxg'; // allowlist: neweee-pages.pages.dev
const SITEKEY_PROD  = '0x4AAAAAABzukrBYa83MJypa';  // allowlist: ne​weee.com, www.ne​weee.com
function pickSiteKey() {
  const h = location.hostname;
  if (h.endsWith('neweee-pages.pages.dev')) return SITEKEY_PAGES;
  if (h === 'neweee.com' || h === 'www.neweee.com') return SITEKEY_PROD;
  return SITEKEY_PAGES;
}
const SITE_KEY = pickSiteKey();

let widgetId = null;
function enableSubmit(on){ document.getElementById('submitBtn').disabled = !on; }
function tsReady(){
  try{
    widgetId = turnstile.render('#ts-container', {
      sitekey: SITE_KEY,
      retry: 'never',
      callback: (token)=>{
        document.getElementById('ts-response').value = token || '';
        enableSubmit(!!token);
      },
      'expired-callback': ()=>{
        document.getElementById('ts-response').value = '';
        enableSubmit(false);
      },
      'error-callback': ()=>{
        document.getElementById('ts-response').value = '';
        enableSubmit(false);
      }
    });
  }catch(e){ enableSubmit(false); }
}
window.tsReady = tsReady;

// ===== i18n =====

// Нормализуем язык к 'ru' | 'en' | 'uk'
function normalizeLang(v) {
  v = (v || '').toString().toLowerCase();
  if (v === 'ua' || v.startsWith('uk')) return 'uk';
  if (v.startsWith('en')) return 'en';
  return 'ru';
}
function getLang() {
  let v = new URLSearchParams(location.search).get('lang');
  if (!v && window.__lang) v = String(window.__lang);
  if (!v && localStorage.getItem('lang')) v = localStorage.getItem('lang');
  if (!v) v = document.documentElement.lang || navigator.language || 'ru';
  return normalizeLang(v);
}
// Глобальный setter, если не задан твоим общим скриптом
if (typeof window.setLang !== 'function') {
  window.setLang = function (code) {
    const lang = normalizeLang(code);
    localStorage.setItem('lang', lang);
    document.documentElement.lang = lang;
    window.__lang = lang;
    window.dispatchEvent(new CustomEvent('langchange', { detail: { lang } }));
  };
}

const I18N = {
  ru: {
    nav: { back: '← На главную', title: 'Контакты' },
    head: { h1: 'Связаться с нами', lead: 'Опишите задачу — мы предложим варианты решения и свяжемся с вами.' },
    labels: {
      name: 'Ваше имя *', email: 'Email *', phone: 'Телефон / WhatsApp', company: 'Компания',
      service: 'Направление *', deadline: 'Срок / дедлайн', message: 'Краткое описание задачи *',
      choose: 'Выберите…', energy: 'Энергетический инжиниринг', fsa: 'ФСА / ТРИЗ', lab: 'Лабораторные исследования'
    },
    ui: { send: 'Отправить', sending: 'Отправка…', pubs: 'Публикации', copy: 'Скопировать', copied: 'Скопировано ✓' },
    msg: {
      required: 'Пожалуйста, заполните обязательные поля.',
      captcha: 'Подтвердите проверку «Я не робот».',
      fail: 'Не удалось отправить форму. Попробуйте ещё раз через минуту.',
      fallbackAlert: 'Не удалось отправить автоматически. Можно скопировать текст и отправить вручную.'
    },
    success: { title: 'Спасибо!', text: 'Мы получили вашу заявку и свяжемся с вами в ближайшее время.' },
    addr: { title: 'Адрес:', phone: 'Телефон: ( WhatsApp, Viber )' },
    fallbackNote: 'Если автоматическая отправка не прошла, скопируйте текст ниже и отправьте вручную на'
  },
  en: {
    nav: { back: '← Home', title: 'Contacts' },
    head: { h1: 'Get in touch', lead: 'Describe your task — we’ll propose solutions and get back to you.' },
    labels: {
      name: 'Your name *', email: 'Email *', phone: 'Phone / WhatsApp', company: 'Company',
      service: 'Service *', deadline: 'Deadline', message: 'Short brief *',
      choose: 'Choose…', energy: 'Energy engineering', fsa: 'FCA / TRIZ', lab: 'Laboratory research'
    },
    ui: { send: 'Send', sending: 'Sending…', pubs: 'Publications', copy: 'Copy', copied: 'Copied ✓' },
    msg: {
      required: 'Please fill in the required fields.',
      captcha: 'Please complete the “I’m not a robot” check.',
      fail: 'We couldn’t send the form. Please try again in a minute.',
      fallbackAlert: 'Automatic sending failed. You can copy the text and send it manually.'
    },
    success: { title: 'Thank you!', text: 'We’ve received your request and will get back to you shortly.' },
    addr: { title: 'Address:', phone: 'Phone: ( WhatsApp, Viber )' },
    fallbackNote: 'If automatic sending failed, copy the text below and email it to'
  },
  uk: {
    nav: { back: '← На головну', title: 'Контакти' },
    head: { h1: 'Зв’яжіться з нами', lead: 'Опишіть задачу — ми запропонуємо рішення і невдовзі відповімо.' },
    labels: {
      name: 'Ваше ім’я *', email: 'Email *', phone: 'Телефон / WhatsApp', company: 'Компанія',
      service: 'Напрям *', deadline: 'Строк / дедлайн', message: 'Короткий опис задачі *',
      choose: 'Оберіть…', energy: 'Енергетичний інжиніринг', fsa: 'ФСА / TRIZ', lab: 'Лабораторні дослідження'
    },
    ui: { send: 'Надіслати', sending: 'Надсилання…', pubs: 'Публікації', copy: 'Скопіювати', copied: 'Скопійовано ✓' },
    msg: {
      required: 'Будь ласка, заповніть обов’язкові поля.',
      captcha: 'Підтвердіть перевірку «Я не робот».',
      fail: 'Не вдалося надіслати форму. Спробуйте ще раз за хвилину.',
      fallbackAlert: 'Автоматичне надсилання не спрацювало. Ви можете скопіювати текст і надіслати вручну.'
    },
    success: { title: 'Дякуємо!', text: 'Ми отримали вашу заявку і невдовзі з вами зв’яжемося.' },
    addr: { title: 'Адреса:', phone: 'Телефон: ( WhatsApp, Viber )' },
    fallbackNote: 'Якщо автоматичне надсилання не спрацювало, скопіюйте текст нижче й надішліть на'
  }
};

function t(path) {
  const lang = getLang();
  const segs = path.split('.');
  let obj = I18N[lang] || I18N.ru;
  for (const s of segs) { obj = obj?.[s]; if (!obj) break; }
  return (typeof obj === 'string') ? obj : '';
}

function applyLangUI() {
  const lang = getLang();
  document.documentElement.lang = lang;

  // Навигация/заголовки/подписи
  const $ = (id)=>document.getElementById(id);
  if ($('backHome')) $('backHome').textContent = t('nav.back');
  if ($('pageTitle')) $('pageTitle').textContent = t('nav.title');
  if ($('h1')) $('h1').textContent = t('head.h1');
  if ($('lead')) $('lead').textContent = t('head.lead');

  // Метки формы + опции
  if ($('lblName')) $('lblName').textContent = t('labels.name');
  if ($('lblEmail')) $('lblEmail').textContent = t('labels.email');
  if ($('lblPhone')) $('lblPhone').textContent = t('labels.phone');
  if ($('lblCompany')) $('lblCompany').textContent = t('labels.company');
  if ($('lblService')) $('lblService').textContent = t('labels.service');
  if ($('lblDeadline')) $('lblDeadline').textContent = t('labels.deadline');
  if ($('lblMessage')) $('lblMessage').textContent = t('labels.message');

  if ($('optChoose')) $('optChoose').textContent = t('labels.choose');
  if ($('optEnergy')) $('optEnergy').textContent = t('labels.energy');
  if ($('optFSA')) $('optFSA').textContent = t('labels.fsa');
  if ($('optLab')) $('optLab').textContent = t('labels.lab');

  // Кнопки
  const submitBtn = $('submitBtn');
  if (submitBtn) submitBtn.textContent = t('ui.send');
  const btnPubs = $('btnPubs');
  if (btnPubs) btnPubs.textContent = t('ui.pubs');
  const copyBtn = $('copyBtn');
  if (copyBtn) copyBtn.textContent = t('ui.copy');

  // Нижний блок
  if ($('addrTitle')) $('addrTitle').textContent = t('addr.title');
  if ($('phoneTitle')) $('phoneTitle').textContent = t('addr.phone');

  // Перевод подсказки во fallback, если открыт
  const fb = $('fallback'), note = $('fbNote');
  if (fb && note) {
    const mail = (note.querySelector('a')?.outerHTML) || 'office@neweee.com';
    note.innerHTML = `${t('fallbackNote')} ${mail}.`;
  }
}

// Реакция на общий переключатель
window.addEventListener('langchange', applyLangUI);
document.addEventListener('DOMContentLoaded', applyLangUI);

// Быстрый хэндлер для кнопок с data-set-lang (если есть в шаблоне)
document.addEventListener('click', (e)=>{
  const el = e.target.closest('[data-set-lang]');
  if (!el) return;
  const lang = el.getAttribute('data-set-lang');
  if (lang) window.setLang(lang);
});

// ===== Отправка формы: x-www-form-urlencoded на /contact =====
const f = document.getElementById('briefForm');
const fb = document.getElementById('fallback');
const fbText = document.getElementById('fallbackText');
const copyBtn = document.getElementById('copyBtn');

function val(id){ return (document.getElementById(id)?.value || "").trim(); }
function isSpam(){ return (document.getElementById('website')?.value || "").trim().length > 0; }

f.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(isSpam()) return;

  const required = ['name','email','service','message'];
  for(const id of required){
    if(!val(id)){ alert(t('msg.required')); return; }
  }

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true; submitBtn.textContent = t('ui.sending');

  try{
    const fd = new FormData(f);
    const tok = document.getElementById('ts-response').value || '';
    if(!tok){ alert(t('msg.captcha')); throw new Error('no token'); }
    fd.set('cf-turnstile-response', tok);

    const params = new URLSearchParams();
    for (const [k,v] of fd.entries()) params.append(k, String(v));

    const res = await fetch(f.action, {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: params
    });
    const json = await res.json().catch(()=> ({}));

    if(res.ok && json && json.ok){
      const m = { title: t('success.title'), text: t('success.text') };
      f.innerHTML = `<h2>${m.title}</h2><p class="muted">${m.text}</p>`;
    }else{
      throw new Error(json && (json.error || json.text) || ('status '+res.status));
    }
  }catch(err){
    // Fallback — собрать письмо
    const lines = [
      `${t('labels.name').replace(' *','')}: ${val('name')}`,
      `${t('labels.email').replace(' *','')}: ${val('email')}`,
      val('phone') ? `${t('labels.phone')}: ${val('phone')}` : null,
      val('company') ? `${t('labels.company')}: ${val('company')}` : null,
      `${t('labels.service').replace(' *','')}: ${val('service')}`,
      val('deadline') ? `${t('labels.deadline')}: ${val('deadline')}` : null,
      '',
      (t('labels.message').replace(' *','') + ':'),
      val('message')
    ].filter(Boolean);
    fbText.value = lines.join('\r\n');
    fb.style.display = 'block';
    alert(t('msg.fallbackAlert'));
  }finally{
    if(window.turnstile && widgetId!==null) turnstile.reset(widgetId);
    submitBtn.disabled = true; submitBtn.textContent = t('ui.send');
  }
});

copyBtn?.addEventListener('click', async () => {
  try{
    await navigator.clipboard.writeText(fbText.value);
    copyBtn.textContent = t('ui.copied');
    setTimeout(()=> copyBtn.textContent = t('ui.copy'), 1500);
  }catch(e){
    fbText.select(); document.execCommand('copy');
  }
});
</script>
</body>
</html>
